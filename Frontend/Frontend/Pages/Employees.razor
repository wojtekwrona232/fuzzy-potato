@page "/"

@inject NavigationManager _navigationManager
@inject EmployeeService _employeeService

<style>
.chip {
    display: inline;
    -webkit-box-pack: justify;
    -ms-flex-pack: justify;
    justify-content: space-between;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    height: 32px;
    padding: 0 12px;
    margin-right: 1rem;
    font-size: 13px;
    font-weight: 500;
    color: rgba(0,0,0,.6);
    cursor: pointer;
    background-color: #eceff1;
    border-radius: 16px;
    -webkit-transition: opacity .3s linear;
    transition: opacity .3s linear;
    word-wrap: break-word;
    text-transform: none;
    margin-top: 20px;
    margin-bottom: 5px;
}
</style>

@if (_emails.Count > 0)
{
    <button class="btn page-link" @onclick="() => PrintData()">Press to send email</button>
    @foreach (var value in _emails)
    {
        <button class="btn btn-link chip" role="button" aria-disabled="true" @onclick="() => AddSelectedEmployee(value)">@value <b> X</b></button>
    }
}

@if (_data == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <div class="table-wrapper-scroll-y">
        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>Action</th>
                <th>Select</th>
                <th>First name</th>
                <th>Last name</th>
                <th>Email</th>
                <th>Phone number</th>
                <th>Position</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var d in _data.Data)
            {
                <tr>
                    <td>
                        <div>
                            <button class="btn-primary btn" type="button" @onclick="(() => ShowEmployee(d.Id))">See details</button>
                            <button class="btn-warning btn" type="button" @onclick="(() => EditEmployee(d.Id))">Edit</button>
                            <button class="btn btn-danger" type="submit" @onclick="(() => DeleteEmployee(d.Id))">Delete</button>
                        </div>
                    </td>
                    <td>
                        @if (_emails.Contains(d.Email))
                        {
                            <button class="btn page-link" @onclick="(() => AddSelectedEmployee(d.Email))">Remove from email list</button>
                        }
                        else
                        {
                            <button class="btn page-link" @onclick="(() => AddSelectedEmployee(d.Email))">Add to email list</button>
                        }
                    </td>
                    <td>@d.FirstName</td>
                    <td>@d.LastName</td>
                    <td>@d.Email</td>
                    <td>@d.PhoneNumber</td>
                    <td>@d.Position</td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    
    <nav aria-label="Page navigation example">
        <ul class="pagination">
            <li class="page-item">
                <button class="btn page-link" @onclick="(() => RenderPage(_data.PreviousPage))">Previous</button>
            </li>
            @if (_data.PageNumber > 1)
            {
                <li class="page-item">
                    <button class="btn page-link" @onclick="(() => RenderPage(_data.FirstPage))">1</button>
                </li>
            }
            @if (_data.PageNumber > 2)
            {
                <li class="page-item">
                    <button class="btn page-link" @onclick="(() => RenderPage(_data.PreviousPage))">@(_data.PageNumber - 1)</button>
                </li>
            }
            <li class="page-item">
                <button class="btn page-link">@_data.PageNumber</button>
            </li>
            @if (_data.NextPage != null && _data.PageNumber < _data.TotalPages)
            {
                <li class="page-item">
                    <button class="btn page-link" @onclick="(() => RenderPage(_data.NextPage))">@(_data.PageNumber + 1)</button>
                </li>
            }
            <li class="page-item">
                <button class="btn page-link" @onclick="(() => RenderPage(_data.LastPage))">@(_data.TotalPages)</button>
            </li>
            <li class="page-item">
                <button class="btn page-link" @onclick="(() => RenderPage(_data.NextPage))">Next</button>
            </li>
        </ul>
    </nav>
}

@code {
    private BasicPaged _data;
    private readonly List<string> _emails = new();

    protected override async Task OnInitializedAsync()
    {
        _data = await _employeeService.GetBasicPaged();
    }

    void AddSelectedEmployee(string dto)
    {
        if (!_emails.Contains(dto))
        {
            _emails.Add(dto);
        }
        else
        {
            _emails.Remove(dto);
        }
    }
    void ShowEmployee(Guid id)
    {
        _navigationManager.NavigateTo($"details/{id}");
    }

    void EditEmployee(Guid id)
    {
        _navigationManager.NavigateTo($"edit-employee/{id}");
    }

    async void DeleteEmployee(Guid id)
    {
        var resp = await _employeeService.DeleteEmployee(id);
        if (resp.IsSuccessStatusCode || resp.StatusCode == HttpStatusCode.NoContent)
        {
            _navigationManager.NavigateTo("/", true);
        }
    }

    async void RenderPage(Uri uri)
    {
        _data = await _employeeService.GetBasicPaged(uri);
        StateHasChanged();
    }

    void PrintData()
    {
        var value = _emails.Aggregate("", (current, email) => current + email + ";-;");
        value = value.Remove(value.Length-3);
        _navigationManager.NavigateTo($"/send-email/{value}");
    }

}